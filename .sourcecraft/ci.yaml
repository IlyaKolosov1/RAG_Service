on:
  push:
    filter:
      branches: ["main"]

workflows:
  deploy-bot:
    env:

      PRIVATE_KEY_SSH : ${{ secrets.PRIVATE_KEY_SSH }}
      PRIVATE_KEY : ${{ secrets.PRIVATE_KEY }}
      S3_ACCESS_KEY : ${{ secrets.S3_ACCESS_KEY }}
      S3_SECRET_KEY : ${{ secrets.S3_SECRET_KEY }}
      SERVICE_ACCOUNT_ID : ${{ secrets.SERVICE_ACCOUNT_ID }}
      TELEGRAM_TOKEN : ${{ secrets.TELEGRAM_TOKEN }}
      FOLDER_ID : ${{ secrets.FOLDER_ID }}
      KEY_ID : ${{ secrets.KEY_ID }}

    tasks:
      - name: build-and-run-containers
        cubes:

          - name: run-audit
            image: docker.io/library/python:3.11
            script:
              - apt-get update && apt-get install -y docker.io ssh
              - mkdir -p ~/.ssh && echo "$PRIVATE_KEY_SSH" > ~/.ssh/RSNA256 && chmod 600 ~/.ssh/RSNA256
              - ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ~/.ssh/RSNA256 crdlts@10.129.0.15"
                  cd /home/user/bot-deploy;
                  docker build -t audit-service ./audit;
                  docker rm -f audit || true;
                  docker network create bot-network || true;
                  docker run -d --name audit --network bot-network -p 8000:8000 audit-service
                "
